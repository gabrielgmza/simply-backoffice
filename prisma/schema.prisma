generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EMPLOYEES (Backoffice)
// ============================================
model employees {
  id                String          @id @default(uuid())
  email             String          @unique
  first_name        String
  last_name         String
  avatar_url        String?
  password_hash     String
  role              EmployeeRole
  preferences       Json?
  status            EmployeeStatus  @default(ACTIVE)
  last_login_at     DateTime?
  last_activity_at  DateTime?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  
  tickets           tickets[]
  assigned_tickets  tickets[]       @relation("AssignedTickets")
  aria_conversations aria_conversations[]
  ticket_comments   ticket_comments[]
  notifications     notifications[]
  
  @@index([email])
  @@index([role])
  @@index([status])
}

enum EmployeeRole {
  SUPER_ADMIN
  ADMIN
  COMPLIANCE
  CUSTOMER_SERVICE
  ANALYST
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================
// USERS (App)
// ============================================
model users {
  id              String        @id @default(uuid())
  email           String        @unique
  phone           String?       @unique
  password_hash   String?
  
  first_name      String
  last_name       String
  dni             String?       @unique
  birth_date      DateTime?
  gender          String?
  nationality     String?       @default("AR")
  
  address_street  String?
  address_number  String?
  address_city    String?
  address_state   String?
  address_zip     String?
  
  status          UserStatus    @default(PENDING_VERIFICATION)
  kyc_status      KYCStatus     @default(PENDING)
  user_level      UserLevel     @default(PLATA)
  
  points_balance  Int           @default(0)
  lifetime_points Int           @default(0)
  
  preferences     Json?
  fcm_token       String?
  
  last_login_at   DateTime?
  last_login_ip   String?
  
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  account         accounts?
  passkeys        passkeys[]
  sessions        user_sessions[]
  investments     investments[]
  financings      financings[]
  transactions    transactions[]
  cards           cards[]
  user_notifications user_notifications[]
  contacts        contacts[]
  kyc_documents   kyc_documents[]
  risk_flags      risk_flags[]
  otc_operations  otc_operations[]
  fraud_alerts    fraud_alerts[]
  compliance_reports compliance_reports[]
  compliance_reviews compliance_reviews[]
  
  @@index([email])
  @@index([dni])
  @@index([status])
  @@index([user_level])
}

enum UserStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  BLOCKED
  CLOSED
}

enum KYCStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  EXPIRED
}

enum UserLevel {
  PLATA
  ORO
  BLACK
  DIAMANTE
}

// ============================================
// ACCOUNTS (CVU)
// ============================================
model accounts {
  id              String        @id @default(uuid())
  user_id         String        @unique
  user            users         @relation(fields: [user_id], references: [id])
  
  cvu             String        @unique @db.VarChar(22)
  alias           String?       @unique
  alias_changes   Int           @default(0)
  
  balance         Decimal       @default(0) @db.Decimal(15, 2)
  balance_usd     Decimal       @default(0) @db.Decimal(20, 8)
  balance_usdt    Decimal       @default(0) @db.Decimal(20, 8)
  balance_pending Decimal       @default(0) @db.Decimal(15, 2)
  
  daily_limit     Decimal       @default(500000) @db.Decimal(15, 2)
  monthly_limit   Decimal       @default(5000000) @db.Decimal(15, 2)
  
  status          AccountStatus @default(ACTIVE)
  
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  
  @@index([cvu])
  @@index([alias])
}

enum AccountStatus {
  ACTIVE
  BLOCKED
  CLOSED
}

// ============================================
// PASSKEYS (FIDO2)
// ============================================
model passkeys {
  id                  String    @id @default(uuid())
  user_id             String
  user                users     @relation(fields: [user_id], references: [id])
  credential_id       String    @unique
  public_key          String
  counter             Int       @default(0)
  transports          String[]
  device_name         String?
  device_type         String?
  last_used_at        DateTime?
  created_at          DateTime  @default(now())
  
  @@index([user_id])
  @@index([credential_id])
}

// ============================================
// USER SESSIONS
// ============================================
model user_sessions {
  id              String    @id @default(uuid())
  user_id         String
  user            users     @relation(fields: [user_id], references: [id])
  refresh_token   String    @unique
  device_info     Json?
  ip_address      String?
  expires_at      DateTime
  revoked_at      DateTime?
  created_at      DateTime  @default(now())
  
  @@index([user_id])
  @@index([refresh_token])
}

// ============================================
// INVESTMENTS (FCI)
// ============================================
model investments {
  id              String            @id @default(uuid())
  user_id         String
  user            users             @relation(fields: [user_id], references: [id])
  
  amount          Decimal           @db.Decimal(15, 2)
  current_value   Decimal           @db.Decimal(15, 2)
  returns_earned  Decimal           @default(0) @db.Decimal(15, 2)
  
  fci_type        String            @default("money_market")
  annual_rate     Decimal           @default(22.08) @db.Decimal(5, 2)
  
  credit_used     Decimal           @default(0) @db.Decimal(15, 2)
  credit_limit    Decimal           @db.Decimal(15, 2)
  
  status          InvestmentStatus  @default(ACTIVE)
  
  started_at      DateTime          @default(now())
  liquidated_at   DateTime?
  
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  
  returns         investment_returns[]
  financings      financings[]
  
  @@index([user_id])
  @@index([status])
}

enum InvestmentStatus {
  ACTIVE
  LIQUIDATED
  LIQUIDATED_BY_PENALTY
}

// ============================================
// INVESTMENT RETURNS
// ============================================
model investment_returns {
  id              String      @id @default(uuid())
  investment_id   String
  investment      investments @relation(fields: [investment_id], references: [id])
  
  base_amount     Decimal     @db.Decimal(15, 2)
  rate_applied    Decimal     @db.Decimal(8, 6)
  return_amount   Decimal     @db.Decimal(15, 2)
  return_date     DateTime    @db.Date
  
  credited        Boolean     @default(false)
  credited_at     DateTime?
  
  created_at      DateTime    @default(now())
  
  @@unique([investment_id, return_date])
  @@index([investment_id])
  @@index([return_date])
}

// ============================================
// FINANCINGS
// ============================================
model financings {
  id                  String            @id @default(uuid())
  user_id             String
  user                users             @relation(fields: [user_id], references: [id])
  investment_id       String
  investment          investments       @relation(fields: [investment_id], references: [id])
  
  amount              Decimal           @db.Decimal(15, 2)
  total_amount        Decimal           @db.Decimal(15, 2)
  remaining           Decimal           @db.Decimal(15, 2)
  
  installments        Int
  installment_amount  Decimal           @db.Decimal(15, 2)
  interest_rate       Decimal           @default(0) @db.Decimal(5, 2)
  
  destination_type    String?
  destination_ref     String?
  description         String?
  
  status              FinancingStatus   @default(ACTIVE)
  
  penalty_applied     Boolean           @default(false)
  penalty_amount      Decimal?          @db.Decimal(15, 2)
  
  started_at          DateTime          @default(now())
  next_due_date       DateTime
  completed_at        DateTime?
  
  created_at          DateTime          @default(now())
  updated_at          DateTime          @updatedAt
  
  installment_records installments[]
  
  @@index([user_id])
  @@index([investment_id])
  @@index([status])
}

enum FinancingStatus {
  ACTIVE
  COMPLETED
  DEFAULTED
  LIQUIDATED
}

// ============================================
// INSTALLMENTS
// ============================================
model installments {
  id              String              @id @default(uuid())
  financing_id    String
  financing       financings          @relation(fields: [financing_id], references: [id])
  
  number          Int
  amount          Decimal             @db.Decimal(15, 2)
  penalty_amount  Decimal             @default(0) @db.Decimal(15, 2)
  total_due       Decimal             @db.Decimal(15, 2)
  
  status          InstallmentStatus   @default(PENDING)
  due_date        DateTime            @db.Date
  paid_at         DateTime?
  
  created_at      DateTime            @default(now())
  
  @@unique([financing_id, number])
  @@index([financing_id])
  @@index([due_date])
  @@index([status])
}

enum InstallmentStatus {
  PENDING
  PAID
  OVERDUE
  DROPPED
}

// ============================================
// TRANSACTIONS
// ============================================
model transactions {
  id                  String              @id @default(uuid())
  user_id             String
  user                users               @relation(fields: [user_id], references: [id])
  account_id          String?
  
  type                TransactionType
  amount              Decimal             @db.Decimal(15, 2)
  fee                 Decimal             @default(0) @db.Decimal(15, 2)
  total               Decimal             @db.Decimal(15, 2)
  currency            String              @default("ARS")
  
  source_cvu          String?
  destination_cvu     String?
  destination_alias   String?
  
  motive              String?
  reference           String?
  description         String?
  reference_id        String?
  
  status              TransactionStatus   @default(PENDING)
  metadata            Json?
  
  created_at          DateTime            @default(now())
  completed_at        DateTime?
  
  fraud_alerts        fraud_alerts[]
  
  @@index([user_id])
  @@index([account_id])
  @@index([type])
  @@index([status])
  @@index([created_at])
}

enum TransactionType {
  TRANSFER_OUT
  TRANSFER_IN
  SERVICE_PAYMENT
  MOBILE_RECHARGE
  QR_PAYMENT
  CARD_PAYMENT
  INVESTMENT_DEPOSIT
  INVESTMENT_WITHDRAWAL
  INSTALLMENT_PAYMENT
  FCI_RETURN
  PENALTY_CHARGE
  OTC_BUY
  OTC_SELL
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REVERSED
}

// ============================================
// CARDS
// ============================================
model cards {
  id                  String        @id @default(uuid())
  user_id             String
  user                users         @relation(fields: [user_id], references: [id])
  
  token               String        @unique
  last_four           String
  brand               String        @default("VISA")
  type                CardType
  
  daily_limit         Decimal       @db.Decimal(15, 2)
  monthly_limit       Decimal       @db.Decimal(15, 2)
  
  status              CardStatus    @default(ACTIVE)
  expiry_month        Int
  expiry_year         Int
  
  physical_requested  Boolean       @default(false)
  physical_delivered  Boolean       @default(false)
  
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  
  @@index([user_id])
  @@index([token])
}

enum CardType {
  VIRTUAL
  PHYSICAL
}

enum CardStatus {
  ACTIVE
  BLOCKED
  EXPIRED
  CANCELLED
}

// ============================================
// USER NOTIFICATIONS
// ============================================
model user_notifications {
  id          String              @id @default(uuid())
  user_id     String
  user        users               @relation(fields: [user_id], references: [id])
  type        UserNotificationType
  title       String
  body        String
  data        Json?
  read        Boolean             @default(false)
  read_at     DateTime?
  created_at  DateTime            @default(now())
  
  @@index([user_id, read])
  @@index([created_at])
}

enum UserNotificationType {
  TRANSACTION
  INVESTMENT
  FINANCING
  SECURITY
  PROMOTION
  GENERAL
}

// ============================================
// CONTACTS
// ============================================
model contacts {
  id          String    @id @default(uuid())
  user_id     String
  user        users     @relation(fields: [user_id], references: [id])
  alias       String?
  cvu         String
  name        String
  is_favorite Boolean   @default(false)
  last_used   DateTime?
  created_at  DateTime  @default(now())
  
  @@unique([user_id, cvu])
  @@index([user_id])
}

// ============================================
// KYC DOCUMENTS
// ============================================
model kyc_documents {
  id                String        @id @default(uuid())
  user_id           String
  user              users         @relation(fields: [user_id], references: [id])
  type              KYCDocType
  status            KYCDocStatus  @default(PENDING)
  document_url      String?
  selfie_url        String?
  verification_id   String?
  verification_data Json?
  rejection_reason  String?
  created_at        DateTime      @default(now())
  verified_at       DateTime?
  
  @@index([user_id])
  @@index([status])
}

enum KYCDocType {
  DNI_FRONT
  DNI_BACK
  SELFIE
  PROOF_OF_ADDRESS
}

enum KYCDocStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// LANDING (Leads, Contact, etc.)
// ============================================
model leads {
  id                  String    @id @default(uuid())
  nombre              String
  apellido            String
  email               String    @unique
  telefono            String?
  terminos_aceptados  Boolean   @default(false)
  source              String?
  utm_source          String?
  utm_medium          String?
  utm_campaign        String?
  status              String    @default("new")
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
}

model contact_messages {
  id         String   @id @default(uuid())
  nombre     String
  email      String
  asunto     String?
  mensaje    String
  status     String   @default("new")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model calculator_simulations {
  id                      String   @id @default(uuid())
  monto_inversion         Decimal  @db.Decimal(15, 2)
  plazo_meses             Int
  nivel_cliente           String   @default("plata")
  rendimiento_total       Decimal? @db.Decimal(15, 2)
  monto_final             Decimal? @db.Decimal(15, 2)
  financiacion_disponible Decimal? @db.Decimal(15, 2)
  created_at              DateTime @default(now())
}

model newsletter_subscribers {
  id         String   @id @default(uuid())
  email      String   @unique
  status     String   @default("active")
  source     String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

// ============================================
// BACKOFFICE
// ============================================
model tickets {
  id              String          @id @default(uuid())
  title           String
  description     String
  category        TicketCategory
  priority        TicketPriority  @default(MEDIUM)
  status          TicketStatus    @default(OPEN)
  created_by_id   String
  created_by      employees       @relation(fields: [created_by_id], references: [id])
  assigned_to_id  String?
  assigned_to     employees?      @relation("AssignedTickets", fields: [assigned_to_id], references: [id])
  tags            String[]
  attachments     Json?
  created_at      DateTime        @default(now())
  updated_at      DateTime        @updatedAt
  resolved_at     DateTime?
  comments        ticket_comments[]
  
  @@index([status])
  @@index([priority])
  @@index([created_by_id])
  @@index([assigned_to_id])
}

enum TicketCategory {
  BUG
  FEATURE_REQUEST
  QUESTION
  TASK
  INCIDENT
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

model ticket_comments {
  id          String    @id @default(uuid())
  ticket_id   String
  ticket      tickets   @relation(fields: [ticket_id], references: [id])
  employee_id String
  employee    employees @relation(fields: [employee_id], references: [id])
  comment     String
  is_internal Boolean   @default(false)
  created_at  DateTime  @default(now())
  
  @@index([ticket_id])
}

model aria_conversations {
  id          String    @id @default(uuid())
  employee_id String
  employee    employees @relation(fields: [employee_id], references: [id])
  title       String
  messages    Json
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  @@index([employee_id])
}

model notifications {
  id          String    @id @default(uuid())
  employee_id String
  type        String
  title       String
  message     String
  link        String?
  metadata    Json      @default("{}")
  is_read     Boolean   @default(false)
  read_at     DateTime?
  created_at  DateTime  @default(now())
  employee    employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  
  @@index([employee_id])
  @@index([is_read])
}

// ============================================
// SYSTEM SETTINGS (Variables del Sistema)
// ============================================
model system_settings {
  id              String    @id @default(uuid())
  key             String    @unique
  value           String
  value_type      String    @default("string") // string, number, boolean, json
  category        String    // rates, limits, fees, features
  description     String?
  
  // Control de cambios
  updated_by_id   String?
  previous_value  String?
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  @@index([category])
  @@index([key])
}

// ============================================
// SYSTEM SETTINGS HISTORY (Historial de cambios)
// ============================================
model system_settings_history {
  id              String    @id @default(uuid())
  setting_key     String
  old_value       String?
  new_value       String
  changed_by_id   String
  reason          String?
  
  created_at      DateTime  @default(now())
  
  @@index([setting_key])
  @@index([changed_by_id])
  @@index([created_at])
}

// ============================================
// AUDIT LOGS (Registro de Acciones)
// ============================================
model audit_logs {
  id              String    @id @default(uuid())
  
  // Quién
  actor_type      String    // employee, user, system
  actor_id        String?
  actor_email     String?
  actor_role      String?
  
  // Qué
  action          String    // create, update, delete, login, logout, etc.
  resource        String    // users, investments, financings, settings, etc.
  resource_id     String?
  
  // Detalles
  description     String
  old_data        Json?
  new_data        Json?
  metadata        Json?
  
  // Contexto
  ip_address      String?
  user_agent      String?
  
  // Resultado
  status          String    @default("success") // success, failed, blocked
  error_message   String?
  
  created_at      DateTime  @default(now())
  
  @@index([actor_type, actor_id])
  @@index([action])
  @@index([resource, resource_id])
  @@index([created_at])
}

// ============================================
// INTERNAL ACCOUNTS (Cajas Internas)
// ============================================
model internal_accounts {
  id              String    @id @default(uuid())
  
  name            String    @unique // caja_ars, caja_usd, caja_usdt, etc.
  type            String    // main, fci, fees, penalties, otc
  currency        String    // ARS, USD, USDT
  balance         Decimal   @default(0) @db.Decimal(20, 8)
  
  // Control
  status          String    @default("active") // active, blocked, closed
  blocked_reason  String?
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  movements       internal_movements[]
  
  @@index([type])
  @@index([currency])
  @@index([name])
}

// ============================================
// INTERNAL MOVEMENTS (Movimientos Internos)
// ============================================
model internal_movements {
  id                  String            @id @default(uuid())
  
  account_id          String
  internal_accounts   internal_accounts @relation(fields: [account_id], references: [id])
  
  type                String            // DEPOSIT, WITHDRAWAL, TRANSFER, FEE, ADJUSTMENT, RETURN, PENALTY
  amount              Decimal           @db.Decimal(20, 8)
  balance_before      Decimal           @db.Decimal(20, 8)
  balance_after       Decimal           @db.Decimal(20, 8)
  
  // Descripción y referencia
  description         String?
  reference_id        String?
  
  // Usuario relacionado (opcional)
  user_id             String?
  
  // Empleado que realizó la operación
  employee_id         String?
  
  created_at          DateTime          @default(now())
  
  @@index([account_id])
  @@index([type])
  @@index([created_at])
  @@index([reference_id])
}

// ============================================
// RISK FLAGS (Alertas de Riesgo)
// ============================================
model risk_flags {
  id              String    @id @default(uuid())
  
  user_id         String
  users           users     @relation(fields: [user_id], references: [id])
  
  type            String    // high_volume, unusual_pattern, suspicious_ip, manual
  severity        String    // low, medium, high, critical
  status          String    @default("active") // active, resolved, dismissed
  
  description     String
  details         Json?
  
  // Acciones
  action_taken    String?   // none, limited, blocked, reviewed
  resolved_by_id  String?
  resolved_at     DateTime?
  resolution_note String?
  
  created_by      String?
  created_at      DateTime  @default(now())
  
  @@index([user_id])
  @@index([status])
  @@index([severity])
  @@index([created_at])
}

// ============================================
// OTC OPERATIONS (Operaciones OTC)
// ============================================
model otc_operations {
  id                  String    @id @default(uuid())
  
  user_id             String
  users               users     @relation(fields: [user_id], references: [id])
  
  type                String    // BUY, SELL
  asset               String    // USD, USDT, BTC, ETH
  amount              Decimal   @db.Decimal(20, 8)
  rate                Decimal   @db.Decimal(20, 8)
  total_ars           Decimal   @db.Decimal(20, 2)
  fee                 Decimal   @db.Decimal(20, 2)
  
  status              String    @default("PENDING") // PENDING, APPROVED, EXECUTED, CANCELLED, REJECTED
  
  // Aprobación
  created_by          String?
  approved_by         String?
  approved_at         DateTime?
  
  // Ejecución
  executed_by         String?
  executed_at         DateTime?
  
  // Rechazo/Cancelación
  rejection_reason    String?
  rejected_by         String?
  rejected_at         DateTime?
  cancellation_reason String?
  cancelled_at        DateTime?
  
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  @@index([user_id])
  @@index([status])
  @@index([type])
  @@index([created_at])
}

// ============================================
// FRAUD ALERTS (Alertas de Fraude)
// ============================================
model fraud_alerts {
  id                String    @id @default(uuid())
  
  user_id           String
  users             users     @relation(fields: [user_id], references: [id])
  
  transaction_id    String?
  transactions      transactions? @relation(fields: [transaction_id], references: [id])
  
  risk_score        Int       // 0-100
  risk_level        String    // LOW, MEDIUM, HIGH, CRITICAL
  factors           Json      // Array of risk factors
  
  status            String    @default("PENDING") // PENDING, REVIEWING, RESOLVED, ESCALATED, FALSE_POSITIVE
  auto_blocked      Boolean   @default(false)
  
  // Revisión
  reviewed_by       String?
  reviewed_at       DateTime?
  notes             String?
  
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  
  @@index([user_id])
  @@index([status])
  @@index([risk_level])
  @@index([created_at])
}

// ============================================
// BLACKLISTED IPS (IPs Bloqueadas)
// ============================================
model blacklisted_ips {
  id          String    @id @default(uuid())
  ip          String    @unique
  reason      String
  added_by    String
  
  created_at  DateTime  @default(now())
  
  @@index([ip])
}

// ============================================
// COMPLIANCE REPORTS (Reportes UIF)
// ============================================
model compliance_reports {
  id                  String    @id @default(uuid())
  
  type                String    // ROS, ROE, PERIODIC, THRESHOLD
  user_id             String
  users               users     @relation(fields: [user_id], references: [id])
  
  status              String    @default("DRAFT") // DRAFT, PENDING_REVIEW, APPROVED, SUBMITTED, REJECTED
  
  content             Json      // Contenido completo del reporte
  transaction_ids     String[]  // IDs de transacciones involucradas
  amount              Decimal   @db.Decimal(20, 2)
  
  // Aprobación
  created_by          String
  approved_by         String?
  approved_at         DateTime?
  notes               String?
  
  // Envío
  submitted_by        String?
  submitted_at        DateTime?
  external_reference  String?   // Referencia UIF
  
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  @@index([user_id])
  @@index([status])
  @@index([type])
  @@index([created_at])
}

// ============================================
// COMPLIANCE REVIEWS (Revisiones de Compliance)
// ============================================
model compliance_reviews {
  id              String    @id @default(uuid())
  
  user_id         String
  users           users     @relation(fields: [user_id], references: [id])
  
  reason          String
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  due_date        DateTime
  
  // Asignación
  scheduled_by    String
  assigned_to     String?
  
  // Resultado
  completed_by    String?
  completed_at    DateTime?
  result          String?   // APPROVED, REQUIRES_ACTION, BLOCKED
  findings        Json?
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  @@index([user_id])
  @@index([status])
  @@index([due_date])
}
